<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>USBDM: usb_implementation_bulk.h</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">USBDM
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">usb_implementation_bulk.h</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * @file     usb_implementation_bulk.h</span></div><div class="line"><span class="comment"> * @brief    USB Bulk device implementation</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * This module provides an implementation of a USB Bulk interface</span></div><div class="line"><span class="comment"> * including the following end points:</span></div><div class="line"><span class="comment"> *  - EP0 Standard control</span></div><div class="line"><span class="comment"> *  - EP1 Bulk OUT</span></div><div class="line"><span class="comment"> *  - EP2 Bulk IN</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * @version  V4.12.1.170</span></div><div class="line"><span class="comment"> * @date     2 April 2017</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> *  This file provides the implementation specific code for the USB interface.</span></div><div class="line"><span class="comment"> *  It will need to be modified to suit an application.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#ifndef PROJECT_HEADERS_USB_IMPLEMENTATION_BULK_H_</span></div><div class="line"><span class="preprocessor">#define PROJECT_HEADERS_USB_IMPLEMENTATION_BULK_H_</span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Under Windows 8, or 10 there is no need to install a driver for</span></div><div class="line"><span class="comment"> * the bulk end-points if the MS_COMPATIBLE_ID_FEATURE is enabled.</span></div><div class="line"><span class="comment"> * winusb.sys driver will be automatically loaded.</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Under Windows 10 the usbser.sys driver will be loaded automatically</span></div><div class="line"><span class="comment"> * for the CDC (serial) interface</span></div><div class="line"><span class="comment"> *</span></div><div class="line"><span class="comment"> * Under Linux drivers for bulk and CDC are automatically loaded</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="preprocessor">#define MS_COMPATIBLE_ID_FEATURE</span></div><div class="line"></div><div class="line"><span class="keyword">namespace </span><a class="code" href="namespace_u_s_b_d_m.html">USBDM</a> {</div><div class="line"></div><div class="line"><span class="comment">//======================================================================</span></div><div class="line"><span class="comment">// Customise for each USB device</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">/** Causes a semi-unique serial number to be generated for each USB device */</span></div><div class="line"><span class="preprocessor">#define UNIQUE_ID</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifndef SERIAL_NO</span></div><div class="line"><span class="preprocessor">#ifdef UNIQUE_ID</span></div><div class="line"><span class="preprocessor">#define SERIAL_NO           &quot;USBDM-%lu&quot;</span></div><div class="line"><span class="preprocessor">#else</span></div><div class="line"><span class="preprocessor">#define SERIAL_NO           &quot;USBDM-0001&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#ifndef PRODUCT_DESCRIPTION</span></div><div class="line"><span class="preprocessor">#define PRODUCT_DESCRIPTION &quot;USB-Test&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#ifndef MANUFACTURER</span></div><div class="line"><span class="preprocessor">#define MANUFACTURER        &quot;pgo&quot;</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="preprocessor">#ifndef VENDOR_ID</span></div><div class="line"><span class="preprocessor">#define VENDOR_ID             (0x16D0)    // Vendor (actually MCS)</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#ifndef PRODUCT_ID</span></div><div class="line"><span class="preprocessor">#define PRODUCT_ID            (0x9999)</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"><span class="preprocessor">#ifndef VERSION_ID</span></div><div class="line"><span class="preprocessor">#define VERSION_ID            (0x0100)</span></div><div class="line"><span class="preprocessor">#endif</span></div><div class="line"></div><div class="line"><span class="comment">//======================================================================</span></div><div class="line"><span class="comment">// Maximum packet sizes for each endpoint</span></div><div class="line"><span class="comment">//</span></div><div class="line"><span class="keyword">static</span> constexpr uint  CONTROL_EP_MAXSIZE           = 64; <span class="comment">//!&lt; Control in/out</span></div><div class="line"><span class="comment"></span><span class="comment">/*</span></div><div class="line"><span class="comment"> *  TODO Define additional end-point sizes</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">static</span> constexpr uint  BULK_OUT_EP_MAXSIZE          = 64; <span class="comment">//!&lt; Bulk out</span></div><div class="line"><span class="comment"></span><span class="keyword">static</span> constexpr uint  BULK_IN_EP_MAXSIZE           = 64; <span class="comment">//!&lt; Bulk in</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="preprocessor">#ifdef USBDM_USB0_IS_DEFINED</span></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Class representing USB0</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">class </span>Usb0 : <span class="keyword">public</span> <a name="a0"></a><a class="code" href="namespace_u_s_b_d_m.html#ad575062af796ee44ea4cb8ddcb5bb091">UsbBase_T</a>&lt;Usb0Info, CONTROL_EP_MAXSIZE&gt; {</div><div class="line"></div><div class="line">   <span class="keyword">friend</span> UsbBase_T&lt;Usb0Info, CONTROL_EP_MAXSIZE&gt;;</div><div class="line"></div><div class="line"><span class="keyword">public</span>:<span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * String indexes</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    * Must agree with stringDescriptors[] order</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">enum</span> StringIds {<span class="comment"></span></div><div class="line"><span class="comment">      /** Language information for string descriptors */</span></div><div class="line">      s_language_index=0,    <span class="comment">// Must be zero</span><span class="comment"></span></div><div class="line"><span class="comment">      /** Manufacturer */</span></div><div class="line">      s_manufacturer_index,<span class="comment"></span></div><div class="line"><span class="comment">      /** Product Description */</span></div><div class="line">      s_product_index,<span class="comment"></span></div><div class="line"><span class="comment">      /** Serial Number */</span></div><div class="line">      s_serial_index,<span class="comment"></span></div><div class="line"><span class="comment">      /** Configuration Index */</span></div><div class="line">      s_config_index,</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">      /** Name of Bulk interface */</span></div><div class="line">      s_bulk_interface_index,</div><div class="line"></div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional String indexes</span></div><div class="line"><span class="comment">       */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">      /** Marks last entry */</span></div><div class="line">      s_number_of_string_descriptors</div><div class="line">   };</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Endpoint numbers\n</span></div><div class="line"><span class="comment">    * Must be consecutive</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">enum</span> EndpointNumbers {<span class="comment"></span></div><div class="line"><span class="comment">      /** USB Control endpoint number - must be zero */</span></div><div class="line">      CONTROL_ENDPOINT  = 0,</div><div class="line"></div><div class="line">      <span class="comment">/* end-points are assumed consecutive */</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">      /** Bulk out endpoint number */</span></div><div class="line">      BULK_OUT_ENDPOINT,<span class="comment"></span></div><div class="line"><span class="comment">      /** Bulk in endpoint number */</span></div><div class="line">      BULK_IN_ENDPOINT,</div><div class="line"></div><div class="line"></div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional Endpoint numbers here</span></div><div class="line"><span class="comment">       */</span><span class="comment"></span></div><div class="line"><span class="comment">      /** Total number of end-points */</span></div><div class="line">      NUMBER_OF_ENDPOINTS,</div><div class="line">   };</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Configuration numbers, consecutive from 1</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">enum</span> Configurations {</div><div class="line">      CONFIGURATION_NUM = 1,</div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * Assumes single configuration</span></div><div class="line"><span class="comment">       */</span><span class="comment"></span></div><div class="line"><span class="comment">      /** Total number of configurations */</span></div><div class="line">      NUMBER_OF_CONFIGURATIONS = CONFIGURATION_NUM,</div><div class="line">   };</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * String descriptor table</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> uint8_t *<span class="keyword">const</span> stringDescriptors[];</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:</div><div class="line">   <span class="comment">/* end-points */</span></div><div class="line">   <span class="keyword">static</span> OutEndpoint &lt;Usb0Info, Usb0::BULK_OUT_ENDPOINT, BULK_OUT_EP_MAXSIZE&gt; epBulkOut;</div><div class="line">   <span class="keyword">static</span> InEndpoint  &lt;Usb0Info, Usb0::BULK_IN_ENDPOINT,  BULK_IN_EP_MAXSIZE&gt;  epBulkIn;</div><div class="line"></div><div class="line">   <span class="comment">/*</span></div><div class="line"><span class="comment">    * TODO Add additional End-points here</span></div><div class="line"><span class="comment">    */</span></div><div class="line"></div><div class="line"><span class="keyword">public</span>:</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Initialise the USB0 interface</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    *  @note Assumes clock set up for USB operation (48MHz)</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> initialise();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    *  Blocking transmission of data over bulk IN end-point</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    *  @param size   Number of bytes to send</span></div><div class="line"><span class="comment">    *  @param buffer Pointer to bytes to send</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    *  @note : Waits for idle BEFORE transmission but\n</span></div><div class="line"><span class="comment">    *  returns before data has been transmitted</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> sendBulkData(<span class="keyword">const</span> uint8_t size, <span class="keyword">const</span> uint8_t *buffer);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    *  Blocking reception of data over bulk OUT end-point</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    *   @param maxSize Maximum number of bytes to receive</span></div><div class="line"><span class="comment">    *   @param buffer  Pointer to buffer for bytes received</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    *   @return Number of bytes received</span></div><div class="line"><span class="comment">    *</span></div><div class="line"><span class="comment">    *   @note Doesn&#39;t return until command has been received.</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">int</span> receiveBulkData(uint8_t maxSize, uint8_t *buffer);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Device Descriptor</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> <a name="_a1"></a><a class="code" href="struct_device_descriptor.html">DeviceDescriptor</a> deviceDescriptor;</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Other descriptors type</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">struct </span>Descriptors {</div><div class="line">      <a name="_a2"></a><a class="code" href="struct_configuration_descriptor.html">ConfigurationDescriptor</a>                  configDescriptor;</div><div class="line"></div><div class="line">      <a name="_a3"></a><a class="code" href="struct_interface_descriptor.html">InterfaceDescriptor</a>                      bulk_interface;</div><div class="line">      <a name="_a4"></a><a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>                       bulk_out_endpoint;</div><div class="line">      <a class="code" href="struct_endpoint_descriptor.html">EndpointDescriptor</a>                       bulk_in_endpoint;</div><div class="line"></div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Add additional Descriptors here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">   };</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * All other descriptors</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keyword">const</span> Descriptors otherDescriptors;</div><div class="line"></div><div class="line"><span class="keyword">protected</span>:<span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Initialises all end-points</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> initialiseEndpoints(<span class="keywordtype">void</span>) {</div><div class="line">      epBulkOut.initialise();</div><div class="line">      addEndpoint(&amp;epBulkOut);</div><div class="line">      epBulkOut.setCallback(bulkOutTransactionCallback);</div><div class="line"></div><div class="line">      epBulkIn.initialise();</div><div class="line">      addEndpoint(&amp;epBulkIn);</div><div class="line">      epBulkIn.setCallback(bulkInTransactionCallback);</div><div class="line"></div><div class="line">      <span class="comment">/*</span></div><div class="line"><span class="comment">       * TODO Initialise additional End-points here</span></div><div class="line"><span class="comment">       */</span></div><div class="line">   }</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Callback for SOF tokens</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> sofCallback();</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Call-back handling BULK-OUT transaction complete</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> bulkOutTransactionCallback(<a name="a5"></a><a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Call-back handling BULK-IN transaction complete</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> bulkInTransactionCallback(<a class="code" href="namespace_u_s_b_d_m.html#a124f63fb6f98bc31674386e28e12dacd">EndpointState</a> state);</div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">   /**</span></div><div class="line"><span class="comment">    * Handler for Token Complete USB interrupts for\n</span></div><div class="line"><span class="comment">    * end-points other than EP0</span></div><div class="line"><span class="comment">    */</span></div><div class="line">   <span class="keyword">static</span> <span class="keywordtype">void</span> handleTokenComplete(<span class="keywordtype">void</span>);</div><div class="line"></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">using</span> UsbImplementation = Usb0;</div><div class="line"></div><div class="line"><span class="preprocessor">#endif // USBDM_USB0_IS_DEFINED</span></div><div class="line"></div><div class="line">} <span class="comment">// End namespace USBDM</span></div><div class="line"></div><div class="line"><span class="preprocessor">#endif </span><span class="comment">/* PROJECT_HEADERS_USB_IMPLEMENTATION_BULK_H_ */</span><span class="preprocessor"></span></div></div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Aug 12 2017 08:54:36 for USBDM by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
